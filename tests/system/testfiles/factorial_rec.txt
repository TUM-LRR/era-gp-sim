.equ max_addr, 0x3fc

init_stack:
lui x31, max_addr >> 12
addi x31, x0, max_addr & 0xfff
add x30, x0, x0
jalr x0, x4, 0

; Call fact_rec
addi x1, x0, 12
addi x3, x0, 1
add x5, x0, x0
jal x4, push
call factorial_rec
jal x0, end

; content in x1, ret addr in x4
push:
sw x1, x31, 0
addi x31, x31, -4
addi x30, x30, 1
jalr x0, x4, 0

;content will be placed in x1, ret addr: x4
pop:
beq x30, x0, pop_exn
lw x1, x31, 0
addi x31, x31, 4
addi x30, x30, -1
jalr x0, x4, 0
pop_exn:
simucrash "Stack is empty!"

;reserved registers: x1
.macro call, symbol
auipc x1, 0
addi x1, x1, 4 ;return address
jal x4, push
jal x0, \symbol
.endm

.macro ret
jal x4, pop
jalr x0, x1, 0
.endm

factorial_rec:
jal x4, pop
beq x1, x0, fr_end
jal x4, push
addi x1, x1, -1
jal x4, push
call factorial_rec
jal x4, pop
mul x5, x5, x1
ret

fr_end:
addi x5, x0, 1
ret


end:
add x0, x0, x0 ;NOP
