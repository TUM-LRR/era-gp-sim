% !TEX root = ../../presentation.tex
% Core

\textframe{\texttt{.core}}

\begin{slide}{Interface des Core Moduls}

\begin{figure}[H]
    \begin{center}
        \begin{tikzpicture}[node distance=0.7cm and 2.5cm]

            \onslide<1->{
            \node (gui) [class] {GuiProject};
            }

            \onslide<2->{
            \node (projectModule) [class, below = of gui] {ProjectModule};
            \draw[composition-arrow] (gui) -- (projectModule);
            }

            \onslide<3->{
            \node (architectureAccess) [class, right = of projectModule] {ArchitectureAccess};
            \node (commandInterface) [class, below = of architectureAccess] {CommandInterface};
            \node (parserInterface) [class, below = of commandInterface] {ParserInterface};
            \node (memoryManager) [class, above = of architectureAccess] {MemoryManager};
            \node (memoryAccess) [class, above = of memoryManager] {MemoryAccess};

            \draw[composition-arrow] (projectModule) -- (memoryAccess);
            \draw[composition-arrow] (projectModule) -- (memoryManager);
            \draw[composition-arrow] (projectModule) -- (architectureAccess);
            \draw[composition-arrow] (projectModule) -- (commandInterface);
            \draw[composition-arrow] (projectModule) -- (parserInterface);
            }

            \onslide<4>{
            \node (interface) [below =0.4cm of parserInterface] {\textbf{Synchronisiertes Interface}};
            }

            \begin{pgfonlayer}{background}
                \onslide<4>{
                \path (memoryAccess.west |- memoryAccess.north)+(-1.3,0.5) node (a1) {};
                \path (parserInterface.east |- parserInterface.south)+(1.3,-1.3) node (a2) {};
                \path[rounded corners, draw=black!50, dashed] (a1) rectangle (a2);
                }
            \end{pgfonlayer}{background}

        \end{tikzpicture}
    \end{center}
    \label{fig:core-interface}
\end{figure}


\end{slide}

\begin{slide}{Threading Konzept}

\begin{figure}
    \begin{center}
        \begin{tikzpicture}[node distance=2.0cm and 2.5cm]
            \node (proxy) [class] {Proxy};
            \node (servant) [class, right = of proxy] {Servant};
            \node (scheduler) [class, right = of servant] {Scheduler};
            \node (activeObject) [below = of {$(servant)!0.5!(scheduler)$}] {\textbf{Active Object Thread}};

            \only<1>{
            \draw[dashed-arrow] (proxy) -- (servant);
            \draw[dashed-arrow] (servant) -- (scheduler);
            }

            \only<2>{
            \draw[dashed-arrow] (proxy) to node[yshift=0.3cm]{\small{push(task)}} (servant);
            \draw[dashed-arrow] (servant) to node[yshift=0.3cm]{\small{push(task)}} (scheduler);
            }

            \only<3>{
            \draw[dashed-arrow] (proxy) to node[yshift=0.3cm]{\small{push(task)}} (servant);
            \draw[dashed-arrow] (servant) to node[yshift=0.3cm]{\small{push(task)}} (scheduler);
            \draw[dashed-arrow] (scheduler) to[bend left] node [yshift=-0.4cm]{\small{executeTask()}} (servant);
            }

            \begin{pgfonlayer}{background}
                \path (servant.west |- servant.north)+(-0.5, 0.5) node (a1) {};
                \path (scheduler.east |- scheduler.south)+(0.5, -2.5) node (a2) {};
                \path[rounded corners, draw=black!50, dashed] (a1) rectangle (a2);
            \end{pgfonlayer}{background}
        \end{tikzpicture}

    \end{center}
    \caption{Aufbau eines Active Objects}
    \label{fig:active-object-structure}
\end{figure}

\end{slide}

\begin{slide}{Innerer Aufbau}

\only<1>{
\begin{figure}
    \begin{center}
        \begin{tikzpicture}
            \node (memoryAccess) [class] {MemoryAccess};
            \node (memoryManager) [class, below = of memoryAccess] {MemoryManager};
            \node (architectureAccess) [class, below = of memoryManager] {ArchitectureAccess};
            \node (projectLabel) [below = 0.5cm of architectureAccess] {\textbf{Project Proxy}};

            \begin{pgfonlayer}{background}
                \path (memoryAccess.west |- memoryAccess.north)+(-1.0, 0.5) node (a1) {};
                \path (architectureAccess.east |- architectureAccess.south)+(1.0, -1.5) node (a2) {};
                \path[rounded corners, draw=black!50, dashed] (a1) rectangle (a2);
            \end{pgfonlayer}{background}

            \node (project) [class, right = 5cm of memoryManager] {Project};

            \draw[dashed-arrow] (memoryAccess) -- (project);
            \draw[dashed-arrow] (memoryManager) -- (project);
            \draw[dashed-arrow] (architectureAccess) -- (project);

        \end{tikzpicture}

    \end{center}

\end{figure}
}

\only<2>{
\begin{figure}
    \begin{center}
        \begin{tikzpicture}
            \node (commandInterface) [class] {CommandInterface};
            \node (parserInterface) [class, below = of commandInterface] {ParserInterface};
            \node (parsingLabel) [below = 0.5cm of parserInterface] {\textbf{ParsingAndExecution Proxy}};

            \node (parsingUnit) [class, right = 3.5cm of {$(commandInterface)!0.5!(parserInterface)$}] {ParsingAndExecutionUnit};

            \draw[dashed-arrow] (commandInterface) -- (parsingUnit);
            \draw[dashed-arrow] (parserInterface) -- (parsingUnit);

            \begin{pgfonlayer}{background}
                \path (commandInterface.west |- commandInterface.north)+(-1.6, 1.0) node (a1) {};
                \path (parserInterface.east |- parserInterface.south)+(1.6, -1.5) node (a2) {};
                \path[rounded corners, draw=black!50, dashed] (a1) rectangle (a2);
            \end{pgfonlayer}{background}

        \end{tikzpicture}
    \end{center}
\end{figure}}

\only<3> {
\begin{figure}
    \begin{center}
        \begin{tikzpicture}[node distance=1.0cm and 1.5cm]

            \node (project) [class] {Project};
            \node (memory) [class, right = 4cm of project] {Memory};
            \node (register) [class, above = of memory] {RegisterSet};
            \node (arch) [class, below = of memory] {Architecture};

            \draw[composition-arrow] (project) -- (memory);
            \draw[composition-arrow] (project) -- (register);
            \draw[composition-arrow] (project) -- (arch);
        \end{tikzpicture}
    \end{center}
\end{figure}
}

\only<4> {
\begin{figure}
    \begin{center}
        \begin{tikzpicture}[node distance=1.0cm and 1.5cm]

            \node (parsingUnit) [class] {ParsingAndExecutionUnit};
            \node (parser) [class, right = 4cm of project] {Parser};
            \node (memoryAccess) [class, above = of memory] {MemoryAccess};
            \node (finalRep) [class, below = of memory] {FinalRepresentation};

            \draw[composition-arrow] (parsingUnit) -- (parser);
            \draw[composition-arrow] (parsingUnit) -- (memoryAccess);
            \draw[composition-arrow] (parsingUnit) -- (finalRep);
        \end{tikzpicture}
    \end{center}
\end{figure}
}

\end{slide}

\begin{frame}[fragile]{Ausführung}
\begin{lstlisting}[style=C++]
void execute() {
  // ...
  size_t nextNode = _findNextNode();
  while (true) {
    if (_stopCondition->getFlag()) break;
    if (nextNode >= _finalRepresentation.commandList().size()) break;
    if (!_executeNode(nextNode)) break;

    nextNode = _updateLineNumber(nextNode);
    _syncCallback();
    _syncCondition->waitAndReset();
  }
  // ...
}
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]{Ausführung}
\begin{lstlisting}[style=C++]
bool _executeNode(size_t nodeIndex) {
  // ...
  auto &currentCommand = _finalRepresentation.commandList()[nodeIndex];
  auto validationResult = currentCommand.node()->validateRuntime(_memoryAccess);
  if (!validationResult.isSuccess()) {
    _throwError(validationResult.getMessage());
    return false;
  }
  // ...
  MemoryValue programCounterValue =
      currentCommand.node()->getValue(_memoryAccess);
  _memoryAccess.putRegisterValue(_programCounter.getName(),
                                 programCounterValue);
  return true;
}
\end{lstlisting}
\end{frame}

\begin{slide}{Speicher}

\end{slide}

\begin{slide}{Register}

\end{slide}
